---
const {
  sorted_chapters = [],
  active_chapter_id = "",
  active_thread_key = "cinza",
  build_chapter_href = ({ chapter_id, thread_key }) =>
    `?chapter_id=${chapter_id}&thread_key=${thread_key}`,
  build_chapter_link_props = null,
  build_hover_preview_link_props = null,
} = Astro.props;

const default_map_thread_keys = ["cinza", "suul", "alvorada"];

const map_thread_key_set = new Set(default_map_thread_keys);

for (const chapter of sorted_chapters) {
  for (const scene of chapter?.scenes ?? []) {
    if (typeof scene?.thread_key !== "string" || !scene.thread_key.trim()) {
      continue;
    }

    map_thread_key_set.add(scene.thread_key);
  }
}

const map_thread_keys = [
  ...default_map_thread_keys.filter((thread_key) => {
    return map_thread_key_set.has(thread_key);
  }),
  ...[...map_thread_key_set]
    .filter((thread_key) => {
      return !default_map_thread_keys.includes(thread_key);
    })
    .sort((left_key, right_key) => {
      return left_key.localeCompare(right_key);
    }),
];

const thread_image_src_map = {
  cinza: "/images/eyes/cinza.jpg",
  suul: "/images/eyes/suul.jpg",
  alvorada: "/images/eyes/alvorada.jpg",
};

const thread_trail_rotation_map = {
  cinza: 334,
  suul: 312,
  alvorada: 348,
};

const thread_neon_rgb_map = {
  cinza: "242 246 255",
  suul: "77 214 107",
  alvorada: "255 159 46",
};

const resolve_thread_image_src = (thread_key) => {
  return thread_image_src_map[thread_key] ?? null;
};

const center_x = 50;
const side_lane_step = 18;
const vertical_step = 18;
const base_y = 12;
const side_lane_y_nudge = 2.6;

const side_thread_keys = map_thread_keys.filter((thread_key) => {
  return thread_key !== "cinza";
});

const side_lane_x_map = new Map();

for (const [side_thread_index, thread_key] of side_thread_keys.entries()) {
  const lane_rank = Math.floor(side_thread_index / 2) + 1;
  const lane_direction = side_thread_index % 2 === 0 ? -1 : 1;
  const lane_x = center_x + lane_direction * lane_rank * side_lane_step;

  side_lane_x_map.set(thread_key, lane_x);
}

const row_entries = sorted_chapters.map((chapter, row_index) => {
  const row_y = base_y + row_index * vertical_step;
  const thread_key_set = new Set();

  for (const scene of chapter?.scenes ?? []) {
    if (typeof scene?.thread_key !== "string" || !scene.thread_key.trim()) {
      continue;
    }

    thread_key_set.add(scene.thread_key);
  }

  return {
    chapter,
    row_index,
    row_y,
    has_cinza: thread_key_set.has("cinza"),
    thread_keys: [...thread_key_set],
  };
});

const row_anchor_nodes = row_entries.map((row_entry) => {
  return {
    node_id: row_entry.has_cinza
      ? `${row_entry.chapter.chapter_id}:cinza`
      : `${row_entry.chapter.chapter_id}:cinza:phantom`,
    chapter_id: row_entry.chapter.chapter_id,
    thread_key: "cinza",
    node_kind: row_entry.has_cinza ? "real" : "phantom",
    x: center_x,
    y: row_entry.row_y,
    row_index: row_entry.row_index,
    timeline_position: row_entry.chapter.timeline_position,
  };
});

const real_nodes = row_entries.flatMap((row_entry) => {
  return row_entry.thread_keys.flatMap((thread_key) => {
    if (thread_key === "cinza") {
      return [
        {
          node_id: `${row_entry.chapter.chapter_id}:${thread_key}`,
          chapter_id: row_entry.chapter.chapter_id,
          thread_key,
          node_kind: "real",
          x: center_x,
          y: row_entry.row_y,
          row_index: row_entry.row_index,
          timeline_position: row_entry.chapter.timeline_position,
        },
      ];
    }

    const lane_x = side_lane_x_map.get(thread_key) ?? center_x;

    return [
      {
        node_id: `${row_entry.chapter.chapter_id}:${thread_key}`,
        chapter_id: row_entry.chapter.chapter_id,
        thread_key,
        node_kind: "real",
        x: lane_x,
        y: row_entry.row_y + side_lane_y_nudge,
        row_index: row_entry.row_index,
        timeline_position: row_entry.chapter.timeline_position,
      },
    ];
  });
});

const viewbox_height = Math.max(
  44,
  base_y + row_entries.length * vertical_step + 10,
);

const cinza_trunk_edges = row_anchor_nodes.flatMap((anchor_node, row_index) => {
  const next_anchor_node = row_anchor_nodes[row_index + 1] ?? null;

  if (!next_anchor_node) {
    return [];
  }

  return [
    {
      edge_key: `${anchor_node.node_id}->${next_anchor_node.node_id}`,
      from_node_id: anchor_node.node_id,
      to_node_id: next_anchor_node.node_id,
      from_chapter_id: anchor_node.chapter_id,
      to_chapter_id: next_anchor_node.chapter_id,
      x1: anchor_node.x,
      y1: anchor_node.y,
      x2: next_anchor_node.x,
      y2: next_anchor_node.y,
    },
  ];
});

const canonical_edges_by_thread = side_thread_keys.map((thread_key) => {
  const thread_nodes = real_nodes.filter((node_entry) => {
    return node_entry.thread_key === thread_key;
  });

  const thread_edges = thread_nodes.flatMap((thread_node, node_index) => {
    const next_thread_node = thread_nodes[node_index + 1] ?? null;

    if (!next_thread_node) {
      return [];
    }

    return [
      {
        edge_key: `${thread_node.node_id}->${next_thread_node.node_id}`,
        thread_key,
        from_chapter_id: thread_node.chapter_id,
        to_chapter_id: next_thread_node.chapter_id,
        x1: thread_node.x,
        y1: thread_node.y,
        x2: next_thread_node.x,
        y2: next_thread_node.y,
      },
    ];
  });

  return {
    thread_key,
    edges: thread_edges,
  };
});

const row_connector_edges = real_nodes.flatMap((node_entry) => {
  if (node_entry.thread_key === "cinza") {
    return [];
  }

  const anchor_node = row_anchor_nodes[node_entry.row_index] ?? null;

  if (!anchor_node) {
    return [];
  }

  return [
    {
      edge_key: `${anchor_node.node_id}->${node_entry.node_id}`,
      thread_key: node_entry.thread_key,
      x1: anchor_node.x,
      y1: anchor_node.y,
      x2: node_entry.x,
      y2: node_entry.y,
    },
  ];
});

const canonical_edge_key_set = new Set([
  ...cinza_trunk_edges.map((edge_entry) => {
    return `${edge_entry.from_chapter_id}:${edge_entry.to_chapter_id}`;
  }),
  ...canonical_edges_by_thread.flatMap((thread_entry) => {
    return thread_entry.edges.map((canonical_edge) => {
      return `${canonical_edge.from_chapter_id}:${canonical_edge.to_chapter_id}`;
    });
  }),
]);

const chapter_index_map = new Map();

for (const [row_index, row_entry] of row_entries.entries()) {
  chapter_index_map.set(row_entry.chapter.chapter_id, row_index);
}

const branch_edges = row_entries.flatMap((row_entry, row_index) => {
  const chapter_branch_edges = row_entry.chapter?.branch_edges ?? [];

  return chapter_branch_edges.flatMap((branch_edge) => {
    const target_row_index = chapter_index_map.get(branch_edge?.to_chapter_id);

    if (typeof target_row_index !== "number") {
      return [];
    }

    const source_anchor_node = row_anchor_nodes[row_index] ?? null;
    const target_anchor_node = row_anchor_nodes[target_row_index] ?? null;

    if (!source_anchor_node || !target_anchor_node) {
      return [];
    }

    const edge_key = `${source_anchor_node.chapter_id}:${target_anchor_node.chapter_id}`;

    if (canonical_edge_key_set.has(edge_key)) {
      return [];
    }

    return [
      {
        edge_key,
        condition_label: branch_edge?.condition_label ?? "optional_path",
        x1: source_anchor_node.x,
        y1: source_anchor_node.y,
        x2: target_anchor_node.x,
        y2: target_anchor_node.y,
      },
    ];
  });
});

const map_nodes = [
  ...row_anchor_nodes.filter((anchor_node) => {
    return anchor_node.node_kind === "phantom";
  }),
  ...real_nodes,
];

const map_nodes_with_links = map_nodes.map((node_entry) => {
  const is_clickable_node = node_entry.node_kind === "real";

  if (!is_clickable_node) {
    return {
      ...node_entry,
      is_clickable: false,
      link: null,
      image_src: null,
      neon_rgb: thread_neon_rgb_map[node_entry.thread_key] ?? "214 217 226",
      trail_rotation: thread_trail_rotation_map[node_entry.thread_key] ?? 18,
      core_radius: 2,
      highlight_radius: 2.2,
      halo_radius: 2.34,
      label: node_entry.chapter_id,
    };
  }

  const chapter_link_props =
    typeof build_chapter_link_props === "function"
      ? build_chapter_link_props({
          chapter_id: node_entry.chapter_id,
          thread_key: node_entry.thread_key,
        })
      : {
          href: build_chapter_href({
            chapter_id: node_entry.chapter_id,
            thread_key: node_entry.thread_key,
          }),
        };

  const hover_preview_link_props =
    typeof build_hover_preview_link_props === "function"
      ? build_hover_preview_link_props({
          chapter_id: node_entry.chapter_id,
          thread_key: node_entry.thread_key,
        })
      : null;

  const core_radius = node_entry.thread_key === "cinza" ? 2.7 : 1.95;
  const highlight_radius = core_radius + 0.22;
  const halo_radius = highlight_radius + 0.04;

  return {
    ...node_entry,
    is_clickable: true,
    link: {
      href: chapter_link_props.href,
      hx_get: chapter_link_props.hx_get ?? chapter_link_props.href,
      hx_target: chapter_link_props.hx_target ?? "#rubedo_timeline_interactive",
      hx_select: chapter_link_props.hx_select ?? "#rubedo_timeline_interactive",
      hx_swap: chapter_link_props.hx_swap ?? "morph swap:240ms settle:240ms",
      hx_push_url: chapter_link_props.hx_push_url ?? "false",
    },
    hover_preview: hover_preview_link_props
      ? {
          href: hover_preview_link_props.href,
          hx_get:
            hover_preview_link_props.hx_get ?? hover_preview_link_props.href,
          hx_target:
            hover_preview_link_props.hx_target ??
            "#rubedo_timeline_hover_preview",
          hx_select:
            hover_preview_link_props.hx_select ??
            "#rubedo_timeline_hover_preview",
          hx_swap:
            hover_preview_link_props.hx_swap ?? "morph swap:180ms settle:120ms",
          hx_push_url: hover_preview_link_props.hx_push_url ?? "false",
        }
      : null,
    image_src: resolve_thread_image_src(node_entry.thread_key),
    neon_rgb: thread_neon_rgb_map[node_entry.thread_key] ?? "214 217 226",
    trail_rotation: thread_trail_rotation_map[node_entry.thread_key] ?? 18,
    core_radius,
    highlight_radius,
    halo_radius,
    label: node_entry.chapter_id,
  };
});

const constellation_payload = {
  viewbox_width: 100,
  viewbox_height,
  active_chapter_id,
  active_thread_key,
  nodes: map_nodes_with_links,
  edges: {
    branch: branch_edges,
    trunk: cinza_trunk_edges,
    connectors: row_connector_edges,
    canonical: canonical_edges_by_thread.flatMap((thread_entry) => {
      return thread_entry.edges.map((edge_entry) => {
        return {
          ...edge_entry,
          thread_key: thread_entry.thread_key,
        };
      });
    }),
  },
};
---

<section
  id="rubedo_constellation_map"
  class="rubedo-constellation"
  data-active-thread-key={active_thread_key}
  data-renderer="canvas"
>
  <div class="rubedo-constellation-controls" data-map-controls>
    <button type="button" data-map-action="zoom_out">-</button>
    <input
      type="range"
      data-map-action="zoom_slider"
      min="0"
      max="1"
      step="0.01"
      value="0.25"
    />
    <button type="button" data-map-action="zoom_in">+</button>
    <button type="button" data-map-action="center_active">Center Active</button>
    <span class="rubedo-constellation-zoom-badge" data-map-action="zoom_badge"
      >Zoom Active</span
    >
  </div>
  <canvas class="rubedo-constellation-canvas-surface" tabindex="0"></canvas>
  <div class="rubedo-constellation-label-overlay">
    {
      map_nodes_with_links
        .filter((node_entry) => {
          return node_entry.node_kind === "real";
        })
        .map((node_entry) => {
          const is_active_node =
            node_entry.chapter_id === active_chapter_id &&
            node_entry.thread_key === active_thread_key;

          return (
            <span
              class:list={{
                "rubedo-constellation-node-label": true,
                "is-active": is_active_node,
              }}
              data-node-id={node_entry.node_id}
              style={`left:${node_entry.x}%;top:${(node_entry.y / viewbox_height) * 100}%;`}
            >
              {node_entry.label}
            </span>
          );
        })
    }
  </div>
  <div class="rubedo-constellation-hover-preview-layer">
    <slot name="hover_preview" />
  </div>
  <script
    type="application/json"
    class="rubedo-constellation-payload"
    set:html={JSON.stringify(constellation_payload)}
  />
</section>
