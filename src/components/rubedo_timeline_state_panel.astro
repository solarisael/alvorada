---
import {
  default_thread_key,
  default_thread_modifier,
} from "../utils/timeline_threads.js";

const {
  resolved_view_state = null,
  build_hx_link_attrs = (href) => {
    return {
      hx_get: href,
      hx_target: "#content",
      hx_swap: "morph swap:240ms settle:240ms",
      hx_push_url: "true",
      hx_select: "#content",
    };
  },
  build_canonical_timeline_href = () => "#",
} = Astro.props;

const resolve_fallback_state = (resolved_state) => {
  if (!resolved_state) {
    return "no_scene";
  }

  const requested_matches_resolved =
    resolved_state.requested_thread_key ===
      resolved_state.resolved_thread_key &&
    resolved_state.requested_thread_modifier ===
      resolved_state.resolved_thread_modifier;

  if (requested_matches_resolved) {
    return "exact";
  }

  const used_thread_core =
    resolved_state.requested_thread_key ===
      resolved_state.resolved_thread_key &&
    resolved_state.resolved_thread_modifier === default_thread_modifier;

  if (used_thread_core) {
    return "thread_core_fallback";
  }

  const used_cinza_core =
    resolved_state.resolved_thread_key === default_thread_key &&
    resolved_state.resolved_thread_modifier === default_thread_modifier;

  if (used_cinza_core) {
    return "cinza_core_fallback";
  }

  return "scene_fallback";
};

const build_link_bundle = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  return {
    href: build_canonical_timeline_href({
      chapter_id,
      thread_key,
      thread_modifier,
    }),
    ...build_hx_link_attrs(
      build_canonical_timeline_href({
        chapter_id,
        thread_key,
        thread_modifier,
      }),
    ),
  };
};

const fallback_state = resolve_fallback_state(resolved_view_state);

const thread_options =
  resolved_view_state?.thread_options.map((thread_key) => {
    return {
      thread_key,
      ...build_link_bundle({
        chapter_id: resolved_view_state.chapter_id,
        thread_key,
        thread_modifier: default_thread_modifier,
      }),
    };
  }) ?? [];

const modifier_options =
  resolved_view_state?.modifier_options.map((thread_modifier) => {
    return {
      thread_modifier,
      ...build_link_bundle({
        chapter_id: resolved_view_state.chapter_id,
        thread_key: resolved_view_state.requested_thread_key,
        thread_modifier,
      }),
    };
  }) ?? [];
---

{
  resolved_view_state && (
    <>
      <section
        class="rubedo-timeline-panel-card rubedo-timeline-filters-card"
        data-current-chapter-id={resolved_view_state.chapter_id}
        data-current-thread-key={resolved_view_state.requested_thread_key}
        data-current-thread-modifier={
          resolved_view_state.requested_thread_modifier
        }
      >
        <h2>Eyes and thread state</h2>

        <div class="rubedo-timeline-controls" data-rubedo-timeline-controls>
          <label>
            <span>Eye thread</span>
            <select
              name="thread_key"
              hx-on:change={`htmx.ajax('GET', this.value, {target: '#rubedo_timeline_interactive', select: '#rubedo_timeline_interactive', swap: 'morph swap:240ms settle:240ms'});`}
            >
              {thread_options.map((thread_option) => {
                const is_current_thread =
                  thread_option.thread_key ===
                  resolved_view_state.requested_thread_key;

                return (
                  <option
                    value={thread_option.href}
                    selected={is_current_thread}
                  >
                    {thread_option.thread_key}
                  </option>
                );
              })}
            </select>
          </label>

          <label>
            <span>Thread modifier</span>
            <select
              name="thread_modifier"
              hx-on:change={`htmx.ajax('GET', this.value, {target: '#rubedo_timeline_interactive', select: '#rubedo_timeline_interactive', swap: 'morph swap:240ms settle:240ms'});`}
            >
              {modifier_options.map((modifier_option) => {
                const is_current_modifier =
                  modifier_option.thread_modifier ===
                  resolved_view_state.requested_thread_modifier;

                return (
                  <option
                    value={modifier_option.href}
                    selected={is_current_modifier}
                  >
                    {modifier_option.thread_modifier}
                  </option>
                );
              })}
            </select>
          </label>
        </div>
      </section>

      <section class="rubedo-timeline-panel-card rubedo-timeline-state-lane-card">
        <h3>Current state</h3>
        <p>
          Scene lens:{" "}
          <strong>
            {resolved_view_state.scene?.scene_title ?? "No scene variant found"}
          </strong>
        </p>
        <p>
          Requested: <code>{resolved_view_state.requested_thread_key}</code>/
          <code>{resolved_view_state.requested_thread_modifier}</code>
        </p>
        <p>
          Resolved: <code>{resolved_view_state.resolved_thread_key}</code>/
          <code>{resolved_view_state.resolved_thread_modifier}</code>
        </p>
        <p>
          Fallback state:{" "}
          <span
            class="rubedo-timeline-fallback-badge"
            data-fallback-state={fallback_state}
          >
            {fallback_state}
          </span>
        </p>
      </section>
    </>
  )
}
