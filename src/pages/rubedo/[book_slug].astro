---
import IndexLayout from "../../layouts/index.astro";
import Eyes from "../../components/eyes.astro";
import {
  rubedo_book_map,
  rubedo_book_slugs,
} from "../../data/rubedo/book_timeline.js";
import {
  default_thread_key,
  default_thread_modifier,
  resolve_book_view_state,
} from "../../utils/timeline_threads.js";

export const getStaticPaths = () => {
  return rubedo_book_slugs.map((book_slug) => {
    return {
      params: {
        book_slug,
      },
    };
  });
};

const book_slug = Astro.params.book_slug ?? "unknown-book";
const selected_book_timeline = rubedo_book_map[book_slug] ?? null;

const chapter_id_param = Astro.url.searchParams.get("chapter_id") ?? "";
const thread_key_param =
  Astro.url.searchParams.get("thread_key") ?? default_thread_key;
const thread_modifier_param =
  Astro.url.searchParams.get("thread_modifier") ?? default_thread_modifier;

const resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id: chapter_id_param,
      thread_key: thread_key_param,
      thread_modifier: thread_modifier_param,
    })
  : null;

const build_reader_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  const reader_params = new URLSearchParams();

  if (chapter_id) {
    reader_params.set("chapter_id", chapter_id);
  }

  reader_params.set("thread_key", thread_key);
  reader_params.set("thread_modifier", thread_modifier);

  return `/rubedo/${book_slug}?${reader_params.toString()}`;
};

const eye_options =
  resolved_view_state?.thread_options.map((thread_key) => {
    return {
      thread_key,
      href: build_reader_href({
        chapter_id: resolved_view_state.chapter_id,
        thread_key,
        thread_modifier: default_thread_modifier,
      }),
    };
  }) ?? [];

const modifier_options =
  resolved_view_state?.modifier_options.map((thread_modifier) => {
    return {
      thread_modifier,
      href: build_reader_href({
        chapter_id: resolved_view_state.chapter_id,
        thread_key: resolved_view_state.requested_thread_key,
        thread_modifier,
      }),
    };
  }) ?? [];
---

<IndexLayout body_class="pov_cinza">
  <section aria-label="Rubedo book timeline prototype">
    <article>
      <header>
        <p>~/ rubedo / {book_slug}</p>
        <h1>{selected_book_timeline?.title ?? "Rubedo Book"}</h1>
      </header>

      <div>
        {
          selected_book_timeline ? (
            <p>{selected_book_timeline.synopsis}</p>
          ) : (
            <p>
              Unknown book slug <code>{book_slug}</code>. Available books are
              deterministic and declared in static paths.
            </p>
          )
        }
        <p><a href="/rubedo">Back to Rubedo index</a></p>
      </div>

      {
        selected_book_timeline && resolved_view_state && (
          <>
            <Eyes
              eye_options={eye_options}
              active_thread_key={resolved_view_state.requested_thread_key}
              active_thread_modifier={
                resolved_view_state.requested_thread_modifier
              }
            />

            <section aria-label="Thread modifier selector">
              <p>Thread modifier</p>
              <ul>
                {modifier_options.map((modifier_option) => {
                  const is_active_modifier =
                    modifier_option.thread_modifier ===
                    resolved_view_state.requested_thread_modifier;

                  return (
                    <li>
                      <a
                        href={modifier_option.href}
                        aria-current={is_active_modifier ? "page" : undefined}
                      >
                        {modifier_option.thread_modifier}
                      </a>
                    </li>
                  );
                })}
              </ul>
            </section>

            <section aria-label="Chapter timeline selector">
              <p>Timeline</p>
              <ul>
                {resolved_view_state.sorted_chapters.map((chapter) => {
                  const is_active_chapter =
                    chapter.chapter_id === resolved_view_state.chapter_id;

                  return (
                    <li>
                      <a
                        href={build_reader_href({
                          chapter_id: chapter.chapter_id,
                        })}
                        aria-current={is_active_chapter ? "page" : undefined}
                      >
                        {chapter.chapter_id} ({chapter.title})
                      </a>
                    </li>
                  );
                })}
              </ul>
            </section>

            <section aria-label="Resolved scene output">
              <h2>
                {resolved_view_state.scene?.scene_title ??
                  "No scene variant found"}
              </h2>
              <p>
                Requested view:{" "}
                <code>{resolved_view_state.requested_thread_key}</code>/
                <code>{resolved_view_state.requested_thread_modifier}</code>
              </p>
              <p>
                Resolved view:{" "}
                <code>{resolved_view_state.resolved_thread_key}</code>/
                <code>{resolved_view_state.resolved_thread_modifier}</code>
              </p>
              {resolved_view_state.scene?.scene_lines?.map((scene_line) => {
                return <p>{scene_line}</p>;
              })}
            </section>

            <nav aria-label="Chapter step navigation">
              <ul>
                <li>
                  {resolved_view_state.previous_chapter_id ? (
                    <a
                      href={build_reader_href({
                        chapter_id: resolved_view_state.previous_chapter_id,
                      })}
                    >
                      Previous chapter
                    </a>
                  ) : (
                    <span>Previous chapter</span>
                  )}
                </li>
                <li>
                  {resolved_view_state.next_chapter_id ? (
                    <a
                      href={build_reader_href({
                        chapter_id: resolved_view_state.next_chapter_id,
                      })}
                    >
                      Next chapter
                    </a>
                  ) : (
                    <span>Next chapter</span>
                  )}
                </li>
              </ul>
            </nav>
          </>
        )
      }
    </article>
  </section>
</IndexLayout>
