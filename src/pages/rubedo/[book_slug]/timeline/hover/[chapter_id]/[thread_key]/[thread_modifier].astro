---
import RubedoTimelineHoverPreview from "../../../../../../../components/rubedo_timeline_hover_preview.astro";
import {
  rubedo_book_json_map,
  rubedo_book_slugs,
} from "../../../../../../../data/rubedo/book_timeline_runtime.js";
import {
  collect_thread_keys,
  collect_thread_modifiers_for_chapter,
  default_thread_key,
  default_thread_modifier,
  resolve_book_view_state,
} from "../../../../../../../utils/timeline_threads.js";

export const getStaticPaths = () => {
  return rubedo_book_slugs.flatMap((book_slug) => {
    const selected_book_timeline = rubedo_book_json_map[book_slug] ?? null;

    if (!selected_book_timeline) {
      return [];
    }

    const thread_keys = collect_thread_keys(selected_book_timeline);

    return selected_book_timeline.chapters.flatMap((chapter) => {
      return thread_keys.flatMap((thread_key) => {
        const modifier_options = collect_thread_modifiers_for_chapter(
          chapter,
          thread_key,
        );

        return modifier_options.map((thread_modifier) => {
          return {
            params: {
              book_slug,
              chapter_id: chapter.chapter_id,
              thread_key,
              thread_modifier,
            },
          };
        });
      });
    });
  });
};

const book_slug = Astro.params.book_slug ?? "unknown-book";
const chapter_id_param = Astro.params.chapter_id ?? "";
const thread_key_param = Astro.params.thread_key ?? default_thread_key;
const thread_modifier_param =
  Astro.params.thread_modifier ?? default_thread_modifier;

const selected_book_timeline = rubedo_book_json_map[book_slug] ?? null;

const resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id: chapter_id_param,
      thread_key: thread_key_param,
      thread_modifier: thread_modifier_param,
    })
  : null;

const build_reader_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  return `/rubedo/${book_slug}/${chapter_id}/${thread_key}/${thread_modifier}`;
};
---

<RubedoTimelineHoverPreview
  resolved_view_state={resolved_view_state}
  build_reader_href={build_reader_href}
/>
