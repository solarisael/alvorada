---
import RubedoTimelineStatePanel from "../../../../../../../components/rubedo_timeline_state_panel.astro";
import {
  rubedo_book_map,
  rubedo_book_slugs,
} from "../../../../../../../data/rubedo/book_timeline_runtime.js";
import {
  collect_thread_keys,
  collect_thread_modifiers_for_chapter,
  default_thread_key,
  default_thread_modifier,
  resolve_book_view_state,
} from "../../../../../../../utils/timeline_threads.js";

const build_canonical_timeline_href_for_book = (
  book_slug,
  {
    chapter_id = "",
    thread_key = default_thread_key,
    thread_modifier = default_thread_modifier,
  } = {},
) => {
  const query_params = new URLSearchParams();

  if (chapter_id) {
    query_params.set("chapter_id", chapter_id);
  }

  query_params.set("thread_key", thread_key);
  query_params.set("thread_modifier", thread_modifier);

  return `/rubedo/${book_slug}/timeline?${query_params.toString()}`;
};

const build_fragment_timeline_href_for_book = (
  book_slug,
  {
    chapter_id = "",
    thread_key = default_thread_key,
    thread_modifier = default_thread_modifier,
  } = {},
) => {
  return `/rubedo/${book_slug}/timeline/fragment/${chapter_id}/${thread_key}/${thread_modifier}`;
};

const build_reader_href_for_book = (
  book_slug,
  {
    chapter_id = "",
    thread_key = default_thread_key,
    thread_modifier = default_thread_modifier,
  } = {},
) => {
  const reader_params = new URLSearchParams();

  if (chapter_id) {
    reader_params.set("chapter_id", chapter_id);
  }

  reader_params.set("thread_key", thread_key);
  reader_params.set("thread_modifier", thread_modifier);

  return `/rubedo/${book_slug}?${reader_params.toString()}`;
};

export const getStaticPaths = () => {
  return rubedo_book_slugs.flatMap((book_slug) => {
    const selected_book_timeline = rubedo_book_map[book_slug] ?? null;

    if (!selected_book_timeline) {
      return [];
    }

    return selected_book_timeline.chapters.flatMap((chapter) => {
      const thread_keys = collect_thread_keys(selected_book_timeline);

      return thread_keys.flatMap((thread_key) => {
        const modifier_options = collect_thread_modifiers_for_chapter(
          chapter,
          thread_key,
        );

        return modifier_options.map((thread_modifier) => {
          return {
            params: {
              book_slug,
              chapter_id: chapter.chapter_id,
              thread_key,
              thread_modifier,
            },
          };
        });
      });
    });
  });
};

const book_slug = Astro.params.book_slug ?? "";
const chapter_id = Astro.params.chapter_id ?? "";
const thread_key = Astro.params.thread_key ?? default_thread_key;
const thread_modifier = Astro.params.thread_modifier ?? default_thread_modifier;

const selected_book_timeline = rubedo_book_map[book_slug] ?? null;

const resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id,
      thread_key,
      thread_modifier,
    })
  : null;

if (!selected_book_timeline || !resolved_view_state) {
  throw new Error(`Unknown timeline fragment path for ${book_slug}`);
}
---

<RubedoTimelineStatePanel
  resolved_view_state={resolved_view_state}
  build_canonical_timeline_href={(state_parts) => {
    return build_canonical_timeline_href_for_book(book_slug, state_parts);
  }}
  build_fragment_timeline_href={(state_parts) => {
    return build_fragment_timeline_href_for_book(book_slug, state_parts);
  }}
  build_reader_href={(state_parts) => {
    return build_reader_href_for_book(book_slug, state_parts);
  }}
/>
