---
import IndexLayout from "../../../../../../layouts/index.astro";
import RubedoTimelineConstellation from "../../../../../../components/rubedo_timeline_constellation.astro";
import RubedoTimelineHoverPreview from "../../../../../../components/rubedo_timeline_hover_preview.astro";
import RubedoTimelineStatePanel from "../../../../../../components/rubedo_timeline_state_panel.astro";
import {
  rubedo_book_json_map,
  rubedo_book_slugs,
} from "../../../../../../data/rubedo/book_timeline_runtime.js";
import {
  collect_thread_keys,
  collect_thread_modifiers_for_chapter,
  default_thread_key,
  default_thread_modifier,
  resolve_book_view_state,
} from "../../../../../../utils/timeline_threads.js";

export const getStaticPaths = () => {
  return rubedo_book_slugs.flatMap((book_slug) => {
    const selected_book_timeline = rubedo_book_json_map[book_slug] ?? null;

    if (!selected_book_timeline) {
      return [];
    }

    const thread_keys = collect_thread_keys(selected_book_timeline);

    return selected_book_timeline.chapters.flatMap((chapter) => {
      return thread_keys.flatMap((thread_key) => {
        const modifier_options = collect_thread_modifiers_for_chapter(
          chapter,
          thread_key,
        );

        return modifier_options.map((thread_modifier) => {
          return {
            params: {
              book_slug,
              chapter_id: chapter.chapter_id,
              thread_key,
              thread_modifier,
            },
          };
        });
      });
    });
  });
};

const book_slug = Astro.params.book_slug ?? "unknown-book";
const chapter_id_param = Astro.params.chapter_id ?? "";
const thread_key_param = Astro.params.thread_key ?? default_thread_key;
const thread_modifier_param =
  Astro.params.thread_modifier ?? default_thread_modifier;

const selected_book_timeline = rubedo_book_json_map[book_slug] ?? null;

const resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id: chapter_id_param,
      thread_key: thread_key_param,
      thread_modifier: thread_modifier_param,
    })
  : null;

const default_resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id: "",
      thread_key: default_thread_key,
      thread_modifier: default_thread_modifier,
    })
  : null;

const build_canonical_timeline_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  return `/rubedo/${book_slug}/timeline/${chapter_id}/${thread_key}/${thread_modifier}`;
};

const build_reader_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  return `/rubedo/${book_slug}/${chapter_id}/${thread_key}/${thread_modifier}`;
};

const build_hover_preview_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = default_thread_modifier,
} = {}) => {
  return `/rubedo/${book_slug}/timeline/hover/${chapter_id}/${thread_key}/${thread_modifier}`;
};

const canonical_timeline_href = default_resolved_view_state
  ? `/rubedo/${book_slug}/timeline/${default_resolved_view_state.chapter_id}/${default_resolved_view_state.requested_thread_key}/${default_resolved_view_state.requested_thread_modifier}`
  : `/rubedo/${book_slug}/timeline`;

const build_hx_link_attrs = (href) => {
  return {
    hx_get: href,
    hx_target: "#rubedo_timeline_interactive",
    hx_select: "#rubedo_timeline_interactive",
    hx_swap: "morph swap:240ms settle:240ms",
    hx_push_url: "false",
  };
};
---

<IndexLayout body_class="pov_cinza">
  <section class="rubedo-timeline-page">
    <article>
      <header class="rubedo-timeline-header">
        <h1>{selected_book_timeline?.title ?? "Rubedo Book"} constellation</h1>
      </header>

      {
        selected_book_timeline ? (
          <p>{selected_book_timeline.synopsis}</p>
        ) : (
          <p>
            Unknown book slug <code>{book_slug}</code>. Return to the book
            timeline entry to load a valid state route.
          </p>
        )
      }

      <p>
        <a
          href="/rubedo"
          hx-get="/rubedo"
          hx-target="#content"
          hx-select="#content"
          hx-swap="morph swap:240ms settle:240ms"
          hx-push-url="true"
        >
          Back to Rubedo index
        </a>
      </p>

      <p>
        <a
          href={canonical_timeline_href}
          hx-get={canonical_timeline_href}
          hx-target="#content"
          hx-select="#content"
          hx-swap="morph swap:240ms settle:240ms"
          hx-push-url="true"
        >
          Back to {book_slug} canonical timeline route
        </a>
      </p>

      {
        selected_book_timeline && resolved_view_state && (
          <>
            <section
              id="rubedo_timeline_interactive"
              hx-disinherit="hx-select hx-select-oob"
            >
              <div class="rubedo-timeline-grid">
                <section class="rubedo-timeline-map-card">
                  <h2>Constellation map</h2>

                  <RubedoTimelineConstellation
                    sorted_chapters={resolved_view_state.sorted_chapters}
                    active_chapter_id={resolved_view_state.chapter_id}
                    active_thread_key={resolved_view_state.requested_thread_key}
                    build_chapter_link_props={({ chapter_id, thread_key }) => {
                      const canonical_href = build_canonical_timeline_href({
                        chapter_id,
                        thread_key,
                        thread_modifier: default_thread_modifier,
                      });
                      const hx_link_attrs = build_hx_link_attrs(canonical_href);

                      return {
                        chapter_id,
                        href: canonical_href,
                        hx_get: hx_link_attrs.hx_get,
                        hx_target: hx_link_attrs.hx_target,
                        hx_swap: hx_link_attrs.hx_swap,
                        hx_push_url: hx_link_attrs.hx_push_url,
                        hx_select: hx_link_attrs.hx_select,
                      };
                    }}
                    build_hover_preview_link_props={({
                      chapter_id,
                      thread_key,
                    }) => {
                      const hover_preview_href = build_hover_preview_href({
                        chapter_id,
                        thread_key,
                        thread_modifier: default_thread_modifier,
                      });

                      return {
                        href: hover_preview_href,
                        hx_get: hover_preview_href,
                        hx_target: "#rubedo_timeline_hover_preview",
                        hx_select: "#rubedo_timeline_hover_preview",
                        hx_swap: "morph swap:160ms settle:100ms",
                        hx_push_url: "false",
                      };
                    }}
                  >
                    <RubedoTimelineHoverPreview
                      slot="hover_preview"
                      resolved_view_state={resolved_view_state}
                      build_reader_href={build_reader_href}
                    />
                  </RubedoTimelineConstellation>

                  <ul class="rubedo-timeline-legend">
                    <li>white path = cinza thread</li>
                    <li>green path = suul thread</li>
                    <li>orange path = alvorada thread</li>
                    <li>dashed path = optional branch</li>
                    <li>bright sigil = active chapter</li>
                  </ul>
                </section>

                <RubedoTimelineStatePanel
                  resolved_view_state={resolved_view_state}
                  build_hx_link_attrs={(href) => {
                    return build_hx_link_attrs(href);
                  }}
                  build_canonical_timeline_href={(state_parts) => {
                    return build_canonical_timeline_href(state_parts);
                  }}
                />
              </div>
            </section>
          </>
        )
      }
    </article>
  </section>
</IndexLayout>
