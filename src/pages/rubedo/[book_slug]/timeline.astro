---
import IndexLayout from "../../../layouts/index.astro";
import Eyes from "../../../components/eyes.astro";
import RubedoTimelineConstellation from "../../../components/rubedo_timeline_constellation.astro";
import {
  rubedo_book_map,
  rubedo_book_slugs,
} from "../../../data/rubedo/book_timeline_runtime.js";
import {
  default_thread_key,
  default_thread_modifier,
  resolve_book_view_state,
} from "../../../utils/timeline_threads.js";

export const getStaticPaths = () => {
  return rubedo_book_slugs.map((book_slug) => {
    return {
      params: {
        book_slug,
      },
    };
  });
};

const book_slug = Astro.params.book_slug ?? "unknown-book";
const selected_book_timeline = rubedo_book_map[book_slug] ?? null;

const chapter_id_param = Astro.url.searchParams.get("chapter_id") ?? "";
const thread_key_param =
  Astro.url.searchParams.get("thread_key") ?? default_thread_key;
const thread_modifier_param =
  Astro.url.searchParams.get("thread_modifier") ?? default_thread_modifier;

const resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id: chapter_id_param,
      thread_key: thread_key_param,
      thread_modifier: thread_modifier_param,
    })
  : null;

const build_timeline_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  const reader_params = new URLSearchParams();

  if (chapter_id) {
    reader_params.set("chapter_id", chapter_id);
  }

  reader_params.set("thread_key", thread_key);
  reader_params.set("thread_modifier", thread_modifier);

  return `/rubedo/${book_slug}/timeline?${reader_params.toString()}`;
};

const build_reader_href = ({
  chapter_id = resolved_view_state?.chapter_id ?? "",
  thread_key = resolved_view_state?.requested_thread_key ?? default_thread_key,
  thread_modifier = resolved_view_state?.requested_thread_modifier ??
    default_thread_modifier,
} = {}) => {
  const reader_params = new URLSearchParams();

  if (chapter_id) {
    reader_params.set("chapter_id", chapter_id);
  }

  reader_params.set("thread_key", thread_key);
  reader_params.set("thread_modifier", thread_modifier);

  return `/rubedo/${book_slug}?${reader_params.toString()}`;
};

const eye_options =
  resolved_view_state?.thread_options.map((thread_key) => {
    return {
      thread_key,
      href: build_timeline_href({
        chapter_id: resolved_view_state.chapter_id,
        thread_key,
        thread_modifier: default_thread_modifier,
      }),
    };
  }) ?? [];

const modifier_options =
  resolved_view_state?.modifier_options.map((thread_modifier) => {
    return {
      thread_modifier,
      href: build_timeline_href({
        chapter_id: resolved_view_state.chapter_id,
        thread_key: resolved_view_state.requested_thread_key,
        thread_modifier,
      }),
    };
  }) ?? [];

const resolve_fallback_state = (resolved_state) => {
  if (!resolved_state) {
    return "no_scene";
  }

  const requested_matches_resolved =
    resolved_state.requested_thread_key ===
      resolved_state.resolved_thread_key &&
    resolved_state.requested_thread_modifier ===
      resolved_state.resolved_thread_modifier;

  if (requested_matches_resolved) {
    return "exact";
  }

  const used_thread_core =
    resolved_state.requested_thread_key ===
      resolved_state.resolved_thread_key &&
    resolved_state.resolved_thread_modifier === default_thread_modifier;

  if (used_thread_core) {
    return "thread_core_fallback";
  }

  const used_cinza_core =
    resolved_state.resolved_thread_key === default_thread_key &&
    resolved_state.resolved_thread_modifier === default_thread_modifier;

  if (used_cinza_core) {
    return "cinza_core_fallback";
  }

  return "scene_fallback";
};

const fallback_state = resolve_fallback_state(resolved_view_state);
const resolved_scene_excerpt =
  resolved_view_state?.scene?.scene_excerpt ??
  resolved_view_state?.resolved_chapter_snippet ??
  null;
---

<IndexLayout body_class="pov_cinza">
  <section class="rubedo-timeline-page" aria-label="Rubedo timeline map">
    <article>
      <header class="rubedo-timeline-header">
        <p>~/ rubedo / {book_slug} / timeline</p>
        <h1>{selected_book_timeline?.title ?? "Rubedo Book"} constellation</h1>
      </header>

      {
        selected_book_timeline ? (
          <p>{selected_book_timeline.synopsis}</p>
        ) : (
          <p>
            Unknown book slug <code>{book_slug}</code>. Available books are
            deterministic and declared in static paths.
          </p>
        )
      }

      <p>
        <a href="/rubedo">Back to Rubedo index</a>
      </p>

      {
        selected_book_timeline && resolved_view_state && (
          <>
            <div class="rubedo-timeline-grid">
              <section aria-label="Constellation timeline panel">
                <h2>Constellation map</h2>

                <RubedoTimelineConstellation
                  sorted_chapters={resolved_view_state.sorted_chapters}
                  active_chapter_id={resolved_view_state.chapter_id}
                  build_chapter_href={({ chapter_id }) => {
                    return build_timeline_href({ chapter_id });
                  }}
                />

                <ul class="rubedo-timeline-legend" aria-label="Map legend">
                  <li>solid path = canonical progression</li>
                  <li>dashed path = optional branch</li>
                  <li>bright sigil = active chapter</li>
                </ul>
              </section>

              <section aria-label="Scene state and controls panel">
                <h2>Eyes and thread state</h2>

                <Eyes
                  eye_options={eye_options}
                  active_thread_key={resolved_view_state.requested_thread_key}
                  active_thread_modifier={
                    resolved_view_state.requested_thread_modifier
                  }
                />

                <section aria-label="Thread modifier selector">
                  <p>Thread modifier</p>
                  <ul>
                    {modifier_options.map((modifier_option) => {
                      const is_active_modifier =
                        modifier_option.thread_modifier ===
                        resolved_view_state.requested_thread_modifier;

                      return (
                        <li>
                          <a
                            href={modifier_option.href}
                            aria-current={
                              is_active_modifier ? "page" : undefined
                            }
                          >
                            {modifier_option.thread_modifier}
                          </a>
                        </li>
                      );
                    })}
                  </ul>
                </section>

                <section aria-label="Resolved scene excerpt">
                  <h3>
                    {resolved_view_state.resolved_chapter_title ??
                      "Unknown chapter"}
                  </h3>
                  {resolved_view_state.resolved_chapter_description && (
                    <p>{resolved_view_state.resolved_chapter_description}</p>
                  )}
                  {resolved_view_state.resolved_chapter_snippet && (
                    <p>{resolved_view_state.resolved_chapter_snippet}</p>
                  )}
                  <p>
                    Scene lens:{" "}
                    <strong>
                      {resolved_view_state.scene?.scene_title ??
                        "No scene variant found"}
                    </strong>
                  </p>
                  <p>
                    Requested:{" "}
                    <code>{resolved_view_state.requested_thread_key}</code>/
                    <code>{resolved_view_state.requested_thread_modifier}</code>
                  </p>
                  <p>
                    Resolved:{" "}
                    <code>{resolved_view_state.resolved_thread_key}</code>/
                    <code>{resolved_view_state.resolved_thread_modifier}</code>
                  </p>
                  <p>
                    Fallback state:{" "}
                    <span
                      class="rubedo-timeline-fallback-badge"
                      data-fallback-state={fallback_state}
                    >
                      {fallback_state}
                    </span>
                  </p>
                  {resolved_scene_excerpt && <p>{resolved_scene_excerpt}</p>}
                </section>

                <nav aria-label="Chapter step navigation">
                  <ul>
                    <li>
                      {resolved_view_state.previous_chapter_id ? (
                        <a
                          href={build_timeline_href({
                            chapter_id: resolved_view_state.previous_chapter_id,
                          })}
                        >
                          Previous chapter
                        </a>
                      ) : (
                        <span>Previous chapter</span>
                      )}
                    </li>
                    <li>
                      {resolved_view_state.next_chapter_id ? (
                        <a
                          href={build_timeline_href({
                            chapter_id: resolved_view_state.next_chapter_id,
                          })}
                        >
                          Next chapter
                        </a>
                      ) : (
                        <span>Next chapter</span>
                      )}
                    </li>
                  </ul>
                </nav>

                <p>
                  <a
                    href={build_reader_href({
                      chapter_id: resolved_view_state.chapter_id,
                    })}
                  >
                    Open full reader
                  </a>
                </p>
              </section>
            </div>
          </>
        )
      }
    </article>
  </section>
</IndexLayout>
