---
import IndexLayout from "../../../layouts/index.astro";
import {
  rubedo_book_json_map,
  rubedo_book_slugs,
} from "../../../data/rubedo/book_timeline_runtime.js";
import {
  default_thread_key,
  default_thread_modifier,
  resolve_book_view_state,
} from "../../../utils/timeline_threads.js";

export const getStaticPaths = () => {
  return rubedo_book_slugs.map((book_slug) => {
    return {
      params: {
        book_slug,
      },
    };
  });
};

const book_slug = Astro.params.book_slug ?? "unknown-book";
const selected_book_timeline = rubedo_book_json_map[book_slug] ?? null;

const default_resolved_view_state = selected_book_timeline
  ? resolve_book_view_state(selected_book_timeline, {
      chapter_id: "",
      thread_key: default_thread_key,
      thread_modifier: default_thread_modifier,
    })
  : null;

const canonical_timeline_href = default_resolved_view_state
  ? `/rubedo/${book_slug}/timeline/${default_resolved_view_state.chapter_id}/${default_resolved_view_state.requested_thread_key}/${default_resolved_view_state.requested_thread_modifier}`
  : `/rubedo/${book_slug}`;

const canonical_reader_href = default_resolved_view_state
  ? `/rubedo/${book_slug}/${default_resolved_view_state.chapter_id}/${default_resolved_view_state.requested_thread_key}/${default_resolved_view_state.requested_thread_modifier}`
  : `/rubedo/${book_slug}`;
---

<IndexLayout body_class="pov_cinza">
  <section class="rubedo-timeline-page">
    <article>
      <header class="rubedo-timeline-header">
        <p>~/ rubedo / {book_slug} / timeline</p>
        <h1>{selected_book_timeline?.title ?? "Rubedo Book"} constellation</h1>
      </header>

      {
        selected_book_timeline ? (
          <p>{selected_book_timeline.synopsis}</p>
        ) : (
          <p>
            Unknown book slug <code>{book_slug}</code>. Return to Rubedo index.
          </p>
        )
      }

      <p>
        <a
          href="/rubedo"
          hx-get="/rubedo"
          hx-target="#content"
          hx-select="#content"
          hx-swap="morph swap:240ms settle:240ms"
          hx-push-url="true"
        >
          Back to Rubedo index
        </a>
      </p>

      {
        selected_book_timeline && (
          <>
            <p>
              <a
                href={canonical_timeline_href}
                hx-get={canonical_timeline_href}
                hx-target="#content"
                hx-select="#content"
                hx-swap="morph swap:240ms settle:240ms"
                hx-push-url="true"
              >
                Open {book_slug} canonical timeline route
              </a>
            </p>
            <p>
              <a
                href={canonical_reader_href}
                hx-get={canonical_reader_href}
                hx-target="#content"
                hx-select="#content"
                hx-swap="morph swap:240ms settle:240ms"
                hx-push-url="true"
              >
                Open {book_slug} reader route
              </a>
            </p>
          </>
        )
      }
    </article>
  </section>
</IndexLayout>
